<!DOCTYPE html>
<html>
	<head>
		<title>Block Rendering</title>
		<link rel="stylesheet" href="style.css">
		<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Francois%20One' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Lilita%20One' rel='stylesheet'>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		
		<!-- BEGIN CDN SCRIPTS -->
		
		<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/interactjs@1.9.15/dist/interact.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/mode/javascript/javascript.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/json-lint.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/edit/matchbrackets.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/brace-fold.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldgutter.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldgutter.min.css" />
				
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/json-lint.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/lint.min.js"></script>
		<script src="https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/lint.min.css" />
		
		<!-- END CDN SCRIPTS -->
		
		<script src="../main.js"></script>
		<script src="blockrender.js"></script>
		
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" href="https://aws1.discourse-cdn.com/gethopscotch/original/3X/3/8/3836ff26c18740a553e96462dc1ece3d8e7f4869.png">
		
		<link rel="apple-touch-icon" sizes="180x180" href="/hs-tools/icons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/hs-tools/icons/favicon-16x16.png">
		<link rel="manifest" href="/hs-tools/icons/site.webmanifest">
		<link rel="mask-icon" href="/hs-tools/icons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/hs-tools/icons/favicon.ico">
		<meta name="apple-mobile-web-app-title" content="Hopscotch Tools">
		<meta name="application-name" content="Hopscotch Tools">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="msapplication-config" content="/hs-tools/icons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
		
		<meta name="description" content="Given an ability, this page will render all of the blocks inside of it."/>
		<meta name="keywords" content="build, mod, text, project, hopscotch"/>
		<meta property="og:title" content="Hopscotch Block Rendering">
		<meta property="og:description" content="Given an ability, this page will render all of the blocks inside of it.">
		<meta property="og:image" content="/hs-tools/images/ability-bars.png">
		
		<style>
			html, body {
				font-family: Lato;
				-webkit-overflow-scrolling: touch;
				width: 100%;
				height: 100%;
			}
			@supports not (-webkit-touch-callout: none) {
				/* CSS for other than iOS devices */
				.bl-container::-webkit-scrollbar {
					width: 14px;
					z-index:1001;
				}
				.bl-container::-webkit-scrollbar-track {
					background-color: #eee;
					border-radius: 0;
				}
				.bl-container::-webkit-scrollbar-thumb {
					background-color: rgba(100,100,100,0.8); /*#e6d700;*/
					border-radius: 10px;
					opacity: 0.75;
				}
				.bl-container::-webkit-scrollbar-thumb:active {
				  background-color: rgba(100,100,100,0.7); /*#e6cf00;*/
					opacity:1;
				}
				.bl-container::-webkit-scrollbar-corner {
				  background-color: #eee;
				}
			}
		</style>
	</head>
	<body>
		<button onclick="theme()" id="themebtn" style="right:0;"><i class="fa fa-fw fa-moon-o"> </i></button>
		<div id="blocks-container-resizer" class="resize-drag">
			<div id="blocks-container" class="bl-container" style="padding: 36px 8px;">
				<div class="drag-handle">Block Rendering: Loading...</div>
			</div>
			<div class="resizer"></div>
		</div>
		<div class="edit-box">
			<textarea></textarea>
			<div class="block-preview"></div>
			<span class="controls"><button onclick="editclose()" title="Close without saving (Esc)"><i class="fa fa-close"></i> CLOSE </button><button onclick="editsave()" title="Close and save changes (Ctrl+Enter)"><i class="fa fa-check"></i> SAVE </button></span>
			<span class="lower-controls"><button id="focus-btn" onclick="editfocus()" title="" class=""><i class="fa fa-eye"></i> FOCUS VIEW </button><button onclick="editdelete()" title="Delete Block" class="danger"><i class="fa fa-trash"></i> DELETE </button></span>
			</div>
		</div>
		<script src="../sidenav.min.js"></script>
		<script src="editor.js"></script>
		<script>
			var hsProject, projectDict = {};
			
			var COUNT = 0;
			
			function addBlockFunctions(parent) {
				parent.querySelectorAll(".editbtn").forEach((elm)=>{
					elm.onclick = function(e){
						activeEditBlock = e.target.parentNode.parentNode;
						//document.querySelector(".edit-box textarea").value = JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t");
						document.querySelector(".edit-box").style.display = "block";
						var blockData = JSON.parse(activeEditBlock.getAttribute("data"));
						(jsonToHtml(blockData).focusType != "blocks" || blockData.type == 123) ? document.getElementById("focus-btn").removeAttribute("disabled") : document.getElementById("focus-btn").setAttribute("disabled","");
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
					}
				});
				parent.querySelectorAll("*:not(.disabled) > bl .openbtn").forEach((elm)=>{
					elm.onclick = function(e){
						var parentBlock = e.target.parentNode.parentNode;
						var hasDomInside = Boolean(parentBlock.childElementCount>1/*&&parentBlock.querySelector("div.collapsible").innerHTML.match(/"/)*/);
						if (hasDomInside) {
							parentBlock.classList.toggle("collapsible-container");
							parentBlock.querySelectorAll("div.collapsible").remove();
						} else {
							//If there is no child container, refresh the block and load what's inside.
							activeEditBlock = parentBlock;
							editor.getDoc().setValue(activeEditBlock.getAttribute("data"));
							editsave(true);
						}
					}
				});
				var list = parent.querySelectorAll(".collapsible");
				list.forEach((l)=>{
					new Sortable(l, {
						group: l.parentNode.getAttribute("data-group"),
						ghostClass: 'invis',
						dragClass: 'dragged',
						fallbackTolerance: 5,
						forceFallback: true,
						delayOnTouchOnly: true,
						animation: 150,
						handle: '.handle',
						fallbackOnBody: true,
						swapThreshold: 0.65,
						multiDrag: true,
						selectedClass: 'selected',
						onEnd: function(e){
							console.log("To:", e.to, "\nFrom:", e.from);
							activeEditBlock = e.item;
							editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
							editsave();
						}
					});
				});
			}
			
			function replaceRender(data, tct, desc) {
				if (data == -1) {
					desc = "Entire Project";
					if (hsProject.scenes) {
						data = hsProject.scenes, tct = "scenes";
					} else {
						data = hsProject.objects||[], tct = "objects";
					}
				}
				document.getElementById("blocks-container-resizer").innerHTML = '<div id="blocks-container" class="bl-container" style="padding: 36px 8px;" data-group="'+tct+'"><div class="drag-handle">Block Rendering: ' + desc + (desc!="Entire Project"?' <a title="See Entire Project" href="javascript:replaceRender(-1)">&ic; <i class="fa fa-list-alt"></i></a>':'')+'</div></div><div class="resizer"></div>';
				//Data = Data Array, Top Container Type (e.g. Rules, Objects)
				data.forEach(function(item) {
					var blockElm = document.createElement("div");
					var blockInfo = jsonToHtml(item, undefined, (item.type==123||typeof item == "string"||item.filename!=null||(item.objects&&hsProject.scenes.length>1)));
					blockElm.setAttribute("class", blockInfo.classList);
					blockElm.setAttribute("data", blockInfo.data);
					blockElm.setAttribute("data-group", blockInfo.sortGroup);
					blockElm.innerHTML = blockInfo.innerHTML;
					document.getElementById("blocks-container").appendChild(blockElm);
				});
				
				x = new Sortable(document.querySelector(".bl-container"), {
					group: tct,
					ghostClass: 'invis', dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					onEnd: function(e){
						console.log("To:", e.to, "\nFrom:", e.from);
						activeEditBlock = e.item;
						editor.getDoc().setValue(activeEditBlock.getAttribute("data"));
						editsave();
					}
				});
				
				document.querySelector(".bl-container").setAttribute("data-group", tct);
				
				addBlockFunctions(document);
			}
			req_id = localStorage.getItem("defaultProjUrl")?localStorage.getItem("defaultProjUrl"):(prompt("Project UUID","test")||"").replace(/.*\//,"");
			setTimeout(function(){
				if (!req_id) return;
				XHR.get(/*"https://c.gethopscotch.com/api/v1/projects/test"*/"https://api.allorigins.win/raw?url=https://c.gethopscotch.com/api/v1/projects/"+req_id, function(r){
					try {
						hsProject = JSON.parse(r);
					} catch (E) {
						return alert("Invalid Response");
					}
					formatProject(hsProject);
					replaceRender(-1); //-1 means top (entire project)
					//hsProject = {};
					//console.log(hsProject.abilities);
					//(hsProject.abilities[57].blocks||[]).forEach(function(block) {
				},false);//true);
			}, 400);
			
			var activeEditBlock;
			function editclose() {
				document.querySelector(".edit-box").style.display = "none";
				activeEditBlock = null;
			}
			function editsave(forceOpen) {
				forceOpen = forceOpen||false; // swap state?
				var savetext = editor.getValue()/*document.querySelector(".edit-box textarea").value*/||'{}';
				try {
					//Valid Block
					var info = jsonToHtml(JSON.parse(savetext), undefined, !(forceOpen||activeEditBlock.classList.contains("collapsible-container")));
					//Open the block if forced to open or is already open
					activeEditBlock.innerHTML = info.innerHTML;
					activeEditBlock.setAttribute("class", info.classList);
					activeEditBlock.setAttribute("data", JSON.stringify(JSON.parse(savetext)));
					activeEditBlock.setAttribute("data-group", info.sortGroup);
					
					if (!activeEditBlock.innerHTML) activeEditBlock.parentNode.removeChild(activeEditBlock);
					document.querySelector(".edit-box").style.display = "none";
					addBlockFunctions(activeEditBlock);
					activeEditBlock = null;
				} catch (E) {
					console.error(E);
					//Valid JSON but invalid block, can indicate delete
					try {
						JSON.parse(savetext);
						document.querySelector(".edit-box").style.display = "none";
						activeEditBlock = null;
					} catch (E) {
						alert("Invalid JSON");
					}
				}
			}
			function editdelete() {
				editor.getDoc().setValue('{}');
				if (activeEditBlock) editsave();
			}
			function editfocus() {
				var blockData = JSON.parse(activeEditBlock.getAttribute("data"));
				console.log( "blocks", projectDict.objects[blockData.objectID||"idk"]);
				if (blockData.objects) replaceRender(blockData.objects, "objects", "Objects in “" + blockData.name + "”");
				else if (blockData.rules) replaceRender(blockData.rules, "rules", "Rules of “" + blockData.name + "”");
				else if (blockData.abilityID) replaceRender(Object.keys(projectDict.abilities[blockData.abilityID].blocks).repeatEach(b=>{return projectDict.abilities[blockData.abilityID].blocks[b]}), "blocks", "When “" + (blockLabels[(blockData.parameters[0].datum||{}).type][1]||"").replace(/\u2063\s|\s\u2063/g,"") + "” for “" + (blockData.objectID?projectDict.objects[blockData.objectID||{}].name:JSON.parse(activeEditBlock.parentNode.parentNode.getAttribute("data")).name) + "”");
				else if (blockData.controlScript) replaceRender(Object.keys(projectDict.abilities[blockData.controlScript.abilityID].blocks).repeatEach(b=>{return projectDict.abilities[blockData.controlScript.abilityID].blocks[b]}), "blocks", "Blocks in “" + blockData.description + "”");
				//console.log(activeEditBlock,jsonToHtml(blockData).focusType);
				editclose();
			}
			document.body.onkeydown = function(e) {
				if (!activeEditBlock) return;
				if (e.keyCode == 27) editclose();
				if ((e.ctrlKey||e.metaKey)&&e.keyCode == 13) editsave();
			}
			
			/* CodeMirror */
			var editor = CodeMirror.fromTextArea(document.querySelector("textarea"), {
				matchBrackets: true,
				autoCloseBrackets: true,
				mode: "application/ld+json",
				foldGutter: true,
				lint: true,
				gutters: ["CodeMirror-lint-markers","CodeMirror-linenumbers", "CodeMirror-foldgutter"],
				lineWrapping: false,
				value: '{}',
				lineNumbers: true,
				indentWithTabs: true,
				tabSize: 2
			});
			editor.on("change",function(e){
				try {
					JSON.parse(editor.getValue());
					//console.log("Successful JSON Parse")
					document.querySelector(".edit-box .block-preview").innerHTML = jsonToHtml(JSON.parse(editor.getValue())).innerHTML.replace(/<b class="editbtn"><\/b>/g,"").replace(/ class="(handle|openbtn)/g,' style="cursor:unset;opacity:1;" class="'+"$1");
				} catch (E) {}
			});
			/* Interact JS */
			interact('.resize-drag').resizable({
				//Resize from all edges and corners
				edges: { 
					right: ".resizer",
					bottom: ".resizer"
				},
				listeners: {
					move (event) {
						var target = event.target;
						var x = (parseFloat(target.getAttribute('data-x')) || 0);
						var y = (parseFloat(target.getAttribute('data-y')) || 0);
						//Update the element's style
						target.style.width = event.rect.width + 'px';
						target.style.height = event.rect.height + 'px';
						//Translate when resizing from top or left edges
						x += event.deltaRect.left, y += event.deltaRect.top;
						target.style.webkitTransform = target.style.transform = 'translate(' + x + 'px,' + y + 'px)';
					}
				},
				modifiers: [
					//Keep the edges inside the parent
					interact.modifiers.restrictEdges({
						outer: 'parent'
					}),
					//Minimum size
					interact.modifiers.restrictSize({
					min: { width: 100, height: 50 }
					})
				],
				inertia: true
			}).draggable({
				allowFrom: 'div.bl-container .drag-handle',
				//Enable inertial throwing
				inertia: true,
				//Keep the element within the area of it's parent
				modifiers: [
					interact.modifiers.restrictRect({
					restriction: 'parent',
					endOnly: true
					})
				],
				//Enable autoScroll
				autoScroll: true,

				listeners: {
					//Call this function on every dragmove event
					move (event) {
						var target = event.target;
						//Keep the dragged position in the data-x/data-y attributes
						var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
						var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

						//Translate the element
						target.style.webkitTransform = target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';// update the posiion attributes
						target.setAttribute('data-x', x); target.setAttribute('data-y', y);
					}
				}
			});
		</script>
	</body>
</html>