<!DOCTYPE html>
<html>
	<head>
		<title>Block Rendering</title>
		<link rel="stylesheet" href="style.css">
		<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		
		<!-- BEGIN CDN SCRIPTS -->
		
		<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/interactjs@1.9.15/dist/interact.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/mode/javascript/javascript.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/json-lint.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/edit/matchbrackets.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/brace-fold.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldgutter.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldgutter.min.css" />
				
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/json-lint.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/lint.min.js"></script>
		<script src="https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/lint.min.css" />
		
		<!-- END CDN SCRIPTS -->
		
		<script src="../main.js"></script>
		<script src="blockrender.js"></script>
		
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" href="https://aws1.discourse-cdn.com/gethopscotch/original/3X/3/8/3836ff26c18740a553e96462dc1ece3d8e7f4869.png">
		
		<link rel="apple-touch-icon" sizes="180x180" href="/hs-tools/icons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/hs-tools/icons/favicon-16x16.png">
		<link rel="manifest" href="/hs-tools/icons/site.webmanifest">
		<link rel="mask-icon" href="/hs-tools/icons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/hs-tools/icons/favicon.ico">
		<meta name="apple-mobile-web-app-title" content="Hopscotch Tools">
		<meta name="application-name" content="Hopscotch Tools">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="msapplication-config" content="/hs-tools/icons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
		
		<meta name="description" content="Given an ability, this page will render all of the blocks inside of it."/>
		<meta name="keywords" content="build, mod, text, project, hopscotch"/>
		<meta property="og:title" content="Hopscotch Block Rendering">
		<meta property="og:description" content="Given an ability, this page will render all of the blocks inside of it.">
		<meta property="og:image" content="/hs-tools/images/ability-bars.png">
		
		<style>
			html, body {
				font-family: Lato;
				-webkit-overflow-scrolling: touch;
			}
			@supports not (-webkit-touch-callout: none) {
				/* CSS for other than iOS devices */
				.bl-container::-webkit-scrollbar {
					width: 14px;
					z-index:1001;
				}
				.bl-container::-webkit-scrollbar-track {
					background-color: #eee;
					border-radius: 0;
				}
				.bl-container::-webkit-scrollbar-thumb {
					background-color: #e6d700;
					border-radius: 10px;
					opacity: 0.75;
				}
				.bl-container::-webkit-scrollbar-thumb:active {
				  background-color: #e6cf00;
					opacity:1;
				}
				.bl-container::-webkit-scrollbar-corner {
				  background-color: #eee;
				}
			}
		</style>
	</head>
	<body>
		<div id="blocks-container-resizer" class="resize-drag">
			<div id="blocks-container" class="bl-container" style="padding-bottom: 36px;">
				<!--div><bl class="looks"><c>Set Color <ps style="background:rgb(0,0,0);"></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				<div><bl class="draw"><c>Draw a Trail color <ps><op class="rcol"></op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				<div><bl class="move"><c>Set Position x <ps></ps> y <ps><op class="cnd cm">
					 &ic; testing &ic;</op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				<div><bl class="ctrl"><c>Wait milliseconds <ps><op class="val"><ps><i class="fa fa-cubes"></i></ps> Horizontal Velocity &ic;</op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				<div><bl class="var"><c>Set <ps><op class="otr"><ps>Self</ps> Clone Index &ic;</op></ps> to <ps><op class="math cm"><ps><op class="val">&ic; &#x1F4F1; Variable Name Text &ic;</op></ps> + <ps>2</ps></op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				<div class="collapsible-container"><bl class="ctrl cl"><c>Check Once If <ps><op class="cnd cm"><ps>7</ps> = <ps>7</ps></op></ps></c><b class="editbtn"></b><b class="handle"></b></bl>
					<div class="collapsible">
						<div><bl class="looks"><c>Set Color <ps style="background:rgb(0,0,0);"></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
						<div class="collapsible-container draw"><bl class="draw cl"><c>Draw a Trail color <ps><op class="rcol"></op></ps> width <ps></ps></c><b class="editbtn"></b><b class="handle"></b></bl>
							<div class="collapsible">
								<div><bl class="looks"><c>Set Color <ps style="background:rgb(0,0,0);"></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
							</div>
						</div>
					</div>
					<div class="collapsible">
						<div><bl class="move"><c>Set Position x <ps></ps> y <ps></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
					</div>
				</div-->
			</div>
			<div class="resizer"></div>
		</div>
		<div class="edit-box">
			<textarea></textarea>
			<div class="block-preview"></div>
			<span class="controls"><button onclick="editclose()" title="Close without saving (Esc)"><i class="fa fa-close"></i> CLOSE </button><button onclick="editsave()" title="Close and save changes (Ctrl+Enter)"><i class="fa fa-check"></i> SAVE </button></span>
			<span class="lower-controls"><button disabled onclick="" title="" class=""><i class="fa fa-eye"></i> FOCUS VIEW </button><button onclick="editdelete()" title="Delete Block" class="danger"><i class="fa fa-trash"></i> DELETE </button></span>
			</div>
		</div>
		<script>
			//var hsProject = {};
			
			var COUNT = 0;
			
			function addBlockFunctions(parent) {
				parent.querySelectorAll(".editbtn").forEach((elm)=>{
					elm.onclick = function(e){
						activeEditBlock = e.target.parentNode.parentNode;
						//document.querySelector(".edit-box textarea").value = JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t");
						document.querySelector(".edit-box").style.display = "block";
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
					}
				});
				parent.querySelectorAll("*:not(.disabled) > bl .openbtn").forEach((elm)=>{
					elm.onclick = function(e){
						var parentBlock = e.target.parentNode.parentNode;
						var hasDomInside = Boolean(parentBlock.childElementCount>1/*&&parentBlock.querySelector("div.collapsible").innerHTML.match(/"/)*/);
						if (hasDomInside) {
							parentBlock.classList.toggle("collapsible-container");
							parentBlock.querySelectorAll("div.collapsible").remove();
						} else {
							//If there is no child container, refresh the block and load what's inside.
							activeEditBlock = parentBlock;
							editor.getDoc().setValue(activeEditBlock.getAttribute("data"));
							editsave(true);
						}
					}
				});
				var list = parent.querySelectorAll(".collapsible");
				list.forEach((l)=>{
					new Sortable(l, {
						group: l.parentNode.getAttribute("data-group"),
						ghostClass: 'invis',
						dragClass: 'dragged',
						fallbackTolerance: 5,
						forceFallback: true,
						delayOnTouchOnly: true,
						animation: 150,
						handle: '.handle',
						fallbackOnBody: true,
						swapThreshold: 0.65,
						multiDrag: true,
						selectedClass: 'selected',
						onEnd: function(e){
							console.log("ðŸ¥©ðŸ¥© To:", e.to, "ðŸ¥žðŸ¥ž From:", e.from);
							activeEditBlock = e.item;
							editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
							editsave();
						}
					});
				});
			}
			
			setTimeout(function(){
				XHR.get(/*"https://c.gethopscotch.com/api/v1/projects/test"*/"https://api.allorigins.win/raw?url=https://c.gethopscotch.com/api/v1/projects/"+(prompt("Project UUID","test")||"").replace(/.*\//,""), function(r){
					try {
						hsProject = JSON.parse(r);
					} catch (E) {
						return alert("Invalid Response");
					}
					//hsProject = {};
					//console.log(hsProject.abilities);
					//(hsProject.abilities[57].blocks||[]).forEach(function(block) {
					(hsProject.objects||[]).forEach(function(block) {
						var blockElm = document.createElement("div");
						var blockInfo = jsonToHtml(block, undefined, (block.type==123||typeof block == "string"||block.filename!=null));
						blockElm.setAttribute("class", blockInfo.classList);
						blockElm.setAttribute("data", blockInfo.data);
						blockElm.setAttribute("data-group", blockInfo.sortGroup);
						blockElm.innerHTML = blockInfo.innerHTML;
						document.getElementById("blocks-container").appendChild(blockElm);
					});
					
					new Sortable(document.querySelector(".bl-container"), {
						group: 'rules',
						ghostClass: 'invis',
						dragClass: 'dragged',
						fallbackTolerance: 5,
						forceFallback: true,
						delayOnTouchOnly: true,
						animation: 150,
						handle: '.handle',
						multiDrag: true,
						selectedClass: 'selected',
						onEnd: function(e){
							console.log("ðŸ¥©ðŸ¥© To:", e.to, "ðŸ¥žðŸ¥ž From:", e.from);
							activeEditBlock = e.item;
							editor.getDoc().setValue(activeEditBlock.getAttribute("data"));
							editsave();
						}
					});
					
					addBlockFunctions(document);
				},false);//true);
			}, 400);
			
			var activeEditBlock;
			function editclose() {
				document.querySelector(".edit-box").style.display = "none";
				activeEditBlock = null;
			}
			function editsave(forceOpen) {
				forceOpen = forceOpen||false; // swap state?
				var savetext = editor.getValue()/*document.querySelector(".edit-box textarea").value*/||'{}';
				try {
					//Valid Block
					var info = jsonToHtml(JSON.parse(savetext), undefined, !(forceOpen||activeEditBlock.classList.contains("collapsible-container")));
					//Open the block if forced to open or is already open
					activeEditBlock.innerHTML = info.innerHTML;
					activeEditBlock.setAttribute("class", info.classList);
					activeEditBlock.setAttribute("data", JSON.stringify(JSON.parse(savetext)));
					activeEditBlock.setAttribute("data-group", info.sortGroup);
					
					if (!activeEditBlock.innerHTML) activeEditBlock.parentNode.removeChild(activeEditBlock);
					document.querySelector(".edit-box").style.display = "none";
					addBlockFunctions(activeEditBlock);
					activeEditBlock = null;
				} catch (E) {
					console.error(E);
					//Valid JSON but invalid block, can indicate delete
					try {
						JSON.parse(savetext);
						document.querySelector(".edit-box").style.display = "none";
						activeEditBlock = null;
					} catch (E) {
						alert("Invalid JSON");
					}
				}
			}
			function editdelete() {
				editor.getDoc().setValue('{}');
				if (activeEditBlock) editsave();
			}
			document.body.onkeydown = function(e) {
				if (!activeEditBlock) return;
				if (e.keyCode == 27) editclose();
				if ((e.ctrlKey||e.metaKey)&&e.keyCode == 13) editsave();
			}
			
			/* CodeMirror */
			var editor = CodeMirror.fromTextArea(document.querySelector("textarea"), {
				matchBrackets: true,
				autoCloseBrackets: true,
				mode: "application/ld+json",
				foldGutter: true,
				lint: true,
				gutters: ["CodeMirror-lint-markers","CodeMirror-linenumbers", "CodeMirror-foldgutter"],
				lineWrapping: false,
				value: '{}',
				lineNumbers: true,
				indentWithTabs: true,
				tabSize: 2
			});
			editor.on("change",function(e){
				try {
					JSON.parse(editor.getValue());
					//console.log("Successful JSON Parse")
					document.querySelector(".edit-box .block-preview").innerHTML = jsonToHtml(JSON.parse(editor.getValue())).innerHTML.replace(/<b class="editbtn"><\/b>/g,"").replace(/ class="(handle|openbtn)/g,' style="cursor:unset;opacity:1;" class="'+"$1");
				} catch (E) {}
			});
			/* Interact JS */
			interact('.resize-drag').resizable({
				// resize from all edges and corners
				edges: { 
					right: ".resizer",
					bottom: ".resizer"
				},
				listeners: {
					move (event) {
					var target = event.target
					var x = (parseFloat(target.getAttribute('data-x')) || 0)
					var y = (parseFloat(target.getAttribute('data-y')) || 0)
					// update the element's style
					target.style.width = event.rect.width + 'px'
					target.style.height = event.rect.height + 'px'
					// translate when resizing from top or left edges
					x += event.deltaRect.left
					y += event.deltaRect.top
					target.style.webkitTransform = target.style.transform =
						'translate(' + x + 'px,' + y + 'px)';
					}
				},
				modifiers: [
					// keep the edges inside the parent
					interact.modifiers.restrictEdges({
					//outer: 'parent'
					}),
					// minimum size
					interact.modifiers.restrictSize({
					min: { width: 100, height: 50 }
					})
				],
				inertia: false
			});
		</script>
	</body>
</html>