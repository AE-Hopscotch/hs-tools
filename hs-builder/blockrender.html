<!DOCTYPE html>
<html>
	<head>
		<title>Block Rendering</title>
		<link rel="stylesheet" href="style.css">
		<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Francois%20One' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Lilita%20One' rel='stylesheet'>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<!-- BEGIN CDN SCRIPTS -->
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script> <!-- DO I NEED THIS -->
		
		<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/interactjs@1.9.15/dist/interact.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/codemirror.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/mode/javascript/javascript.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/json-lint.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/edit/matchbrackets.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/brace-fold.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldgutter.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/fold/foldgutter.min.css" />
				
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/json-lint.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/lint.min.js"></script>
		<script src="https://unpkg.com/jsonlint@1.6.3/web/jsonlint.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.53.2/addon/lint/lint.min.css" />
		
		<!-- END CDN SCRIPTS -->
		
		<script src="../main.js"></script>
		<script src="blockrender.js"></script>
		
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" href="https://aws1.discourse-cdn.com/gethopscotch/original/3X/3/8/3836ff26c18740a553e96462dc1ece3d8e7f4869.png">
		
		<link rel="apple-touch-icon" sizes="180x180" href="/hs-tools/icons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/hs-tools/icons/favicon-16x16.png">
		<link rel="manifest" href="/hs-tools/icons/site.webmanifest">
		<link rel="mask-icon" href="/hs-tools/icons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/hs-tools/icons/favicon.ico">
		<meta name="apple-mobile-web-app-title" content="Hopscotch Tools">
		<meta name="application-name" content="Hopscotch Tools">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="msapplication-config" content="/hs-tools/icons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
		
		<meta name="description" content="This page can render all of the code inside of a Hopscotch Project."/>
		<meta name="keywords" content="build, mod, text, project, hopscotch"/>
		<meta property="og:title" content="Hopscotch Block Rendering">
		<meta property="og:description" content="This page can render all of the code inside of a Hopscotch Project.">
		<meta property="og:image" content="/hs-tools/images/ability-bars.png">
		
		<style>
			html, body {
				font-family: Lato;
				-webkit-overflow-scrolling: touch;
				width: 100%;
				height: 100%;
			}
			@supports (-webkit-touch-callout: none) {
				html, body {
					width: 10000px;
					height: 4000px;
				}
			}
			@supports not (-webkit-touch-callout: none) {
				/* CSS for other than iOS devices */
				.bl-container::-webkit-scrollbar {
					width: 14px;
					z-index:1001;
				}
				.bl-container::-webkit-scrollbar-track {
					background-color: #eee;
					border-radius: 0;
				}
				.bl-container::-webkit-scrollbar-thumb {
					background-color: rgba(100,100,100,0.8); /*#e6d700;*/
					border-radius: 10px;
					opacity: 0.75;
				}
				.bl-container::-webkit-scrollbar-thumb:active {
				  background-color: rgba(100,100,100,0.7); /*#e6cf00;*/
					opacity:1;
				}
				.bl-container::-webkit-scrollbar-corner {
				  background-color: #eee;
				}
			}
		</style>
	</head>
	<body>
		<button onclick="theme()" id="themebtn" style="right:0;"><i class="fa fa-fw fa-moon-o"> </i></button>
		<div id="blocks-container-resizer" class="resize-drag" style="min-width: 300px; left: calc(50vw - 360px); top: 10px;">
			<div class="drag-handle">Block Rendering: Loading...</div>
			<div id="blocks-container" class="bl-container" style="padding: 36px 8px;"></div>
			<div class="resizer"></div>
		</div>
		<div id="iframe-resizer" class="resize-drag" style="width: 220px; min-width: 220px; height: 350px; top: 80px; left: 16px;">
			<div class="drag-handle">Reference Chart</div>
			<div id="blocks-container" class="bl-container" style="padding:27px 0 0;overflow:auto;-webkit-overflow-scrolling:touch;">
				<iframe onfocus="alert()" frameborder="0" src="../hs-help-guide/full-reference.html" id="iframe" class="bl-container" style="padding: 0; height: calc(100% - 27px); position: absolute;"></iframe>
			</div>
			<div class="resizer"></div>
		</div>
		<div id="drawer-resizer" class="resize-drag" style="min-width: 250px; width: 250px; height: 400px; top: 80px; left: calc(100vw - 266px);">
			<div class="drag-handle">Blocks Drawer</div>
			<div class="bl-container">
				<div id="blocks-drawer" style="padding: 36px 8px 4px; height: auto;">
					<div data="{&quot;block_class&quot;:&quot;method&quot;,&quot;description&quot;:&quot;Change Pose&quot;,&quot;type&quot;:33}" data-group="blocks"><bl class="looks"><c>Change Pose</c><b class="editbtn"></b><b class="handle"></b></bl></div>
					<div data="{&quot;block_class&quot;:&quot;method&quot;,&quot;description&quot;:&quot;Set Speed&quot;,&quot;type&quot;:34,&quot;parameters&quot;:[{&quot;defaultValue&quot;:&quot;&quot;,&quot;value&quot;:&quot;&quot;,&quot;key&quot;:&quot;to&quot;,&quot;type&quot;:42}]}" data-group="blocks"><bl class="move"><c>Set speed to <ps><span></span></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
					<div data="{&quot;block_class&quot;:&quot;method&quot;,&quot;description&quot;:&quot;Set&quot;,&quot;type&quot;:45,&quot;parameters&quot;:[{&quot;defaultValue&quot;:&quot;&quot;,&quot;value&quot;:&quot;&quot;,&quot;key&quot;:&quot;&quot;,&quot;type&quot;:47},{&quot;defaultValue&quot;:&quot;&quot;,&quot;value&quot;:&quot;&quot;,&quot;key&quot;:&quot;to&quot;,&quot;type&quot;:48}]}" data-group="blocks"><bl class="var"><c>Set <ps><span></span></ps> to <ps><span></span></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				</div>
				<div id="abilities-drawer" style="padding: 16px 8px 4px; height: auto;">
					<div data="{&quot;block_class&quot;:&quot;control&quot;,&quot;description&quot;:&quot;&quot;,&quot;type&quot;:123,&quot;controlScript&quot;:{&quot;abilityID&quot;:&quot;&quot;}}" data-group="blocks"><bl class="abl"><b class="openbtn"></b><c>New Ability</c><b class="editbtn"></b><b class="handle"></b></bl></div>
				</div>
				<div id="rules-drawer" style="padding: 16px 8px 4px; height: auto;">
					<div data="{&quot;ruleBlockType&quot;:6000,&quot;id&quot;:&quot;&quot;,&quot;objectID&quot;:&quot;&quot;,&quot;name&quot;:&quot;&quot;,&quot;abilityID&quot;:&quot;&quot;,&quot;parameters&quot;:[{&quot;defaultValue&quot;:&quot;&quot;,&quot;datum&quot;:{&quot;type&quot;:7000,&quot;block_class&quot;:&quot;operator&quot;,&quot;description&quot;:&quot;Game Starts&quot;},&quot;key&quot;:&quot;&quot;,&quot;value&quot;:&quot;&quot;,&quot;type&quot;:52}],&quot;type&quot;:6000}" data-group="blocks"><bl class="rule"><b class="openbtn"></b><c>When <ps><op class="cm">&ic; game starts &ic;</op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				</div>
				<div id="customRules-drawer" style="padding: 16px 8px 4px; height: auto;">
					<div data="{&quot;name&quot;:&quot;Custom Rule&quot;,&quot;rules&quot;:[],&quot;id&quot;:&quot;&quot;}" data-group="rules"><bl class="crule"><b class="openbtn"></b><c>Custom Rule</c><b class="editbtn"></b><b class="handle"></b></bl></div>
				</div>
				<div id="objects-drawer" style="padding: 16px 8px 4px; height: auto;">
					<div data="{&quot;height&quot;:&quot;55&quot;,&quot;xPosition&quot;:&quot;512&quot;,&quot;objectID&quot;:&quot;&quot;,&quot;width&quot;:&quot;74&quot;,&quot;text&quot;:&quot;&quot;,&quot;filename&quot;:&quot;text-object.png&quot;,&quot;type&quot;:1,&quot;rules&quot;:[],&quot;name&quot;:&quot;Text&quot;,&quot;yPosition&quot;:&quot;384&quot;}" data-group="rules"><bl class="obj"><b class="openbtn"></b><c>Text <ps><op class="cm">&ic; Text &ic;<ps><span></span></ps></op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
					<div data="{&quot;height&quot;:&quot;150&quot;,&quot;filename&quot;:&quot;fullSizeSquare.png&quot;,&quot;type&quot;:101,&quot;name&quot;:&quot;Square&quot;,&quot;xPosition&quot;:&quot;100&quot;,&quot;width&quot;:&quot;150&quot;,&quot;objectID&quot;:&quot;&quot;,&quot;text&quot;:&quot;&quot;,&quot;rules&quot;:[],&quot;yPosition&quot;:&quot;100&quot;}" data-group="rules"><bl class="obj"><b class="openbtn"></b><c>Square<ps><op class="fw cm"><img style="object-position:0 -3030px" src="../images/character_sprite_strip.png" width="36"></op></ps></c><b class="editbtn"></b><b class="handle"></b></bl></div>
				</div>
				<div id="scenes-drawer" style="padding: 16px 8px 4px; height: auto;">
					<div data="{&quot;objects&quot;:[],&quot;name&quot;:&quot;New Scene&quot;}" data-group="objects"><bl class="scn"><b class="openbtn"></b><c>New Scene</c><b class="editbtn"></b><b class="handle"></b></bl></div>
				</div>
			</div>
			<div class="resizer"></div>
		</div>
		<div class="edit-box">
			<textarea></textarea>
			<div class="block-preview"></div>
			<span class="controls"><button onclick="editclose()" title="Close without saving (Esc)"><i class="fa fa-close"></i> CLOSE </button><button onclick="editsave()" title="Close and save changes (Ctrl+Enter)"><i class="fa fa-check"></i> SAVE </button></span>
			<span class="lower-controls">
				<button id="focus-btn" onclick="editfocus()" title="" class=""><i class="fa fa-eye"></i> FOCUS VIEW </button>
				<button id="copy-btn" onclick="editcopy()" title="" class=""><i class="fa fa-copy"></i> DUPLICATE </button>
				<button onclick="editdelete()" title="Delete Block" class="danger"><i class="fa fa-trash"></i> DELETE </button>
			</span>
		</div>
		<script src="../sidenav.min.js"></script>
		<script src="editor.js"></script>
		<script src="worker.js"></script>
		<script>
			var hsProject, projectDict = {};
			
			var COUNT = 0;
			
			//Use Javascript window width instead to calculate position if inside an iframe on iOS
			if (onIos && self !== top) {
				document.getElementById("blocks-container-resizer").style.left = Math.max(Math.min(window.innerWidth||10**16,window.outerWidth||10**16)/2 - 360, 0) + "px";
				document.getElementById("drawer-resizer").style.left = Math.max(Math.min(window.innerWidth||10**16,window.outerWidth||10**16) - 266, 0) + "px";
			}
			
			//Scale down if on a small screen
			if (Math.min(window.outerWidth,window.outerHeight,window.innerWidth||10**16,window.innerHeight||10**16) < 384) {
				document.querySelector("meta[name=viewport]").setAttribute("content","width=device-width,initial-scale=0.65,minimum-scale=0.65,maximum-scale=0.65");
				document.documentElement.style.setProperty("--viewport-scale","0.65");
			}
			
			function addBlockFunctions(parent) {
				parent.querySelectorAll(".editbtn").forEach((elm)=>{
					elm.onclick = function(e){
						activeEditBlock = e.target.parentNode.parentNode;
						//document.querySelector(".edit-box textarea").value = JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t");
						document.querySelector(".edit-box").style.display = "block";
						var blockData = JSON.parse(activeEditBlock.getAttribute("data"));
						(jsonToHtml(blockData).focusType != "blocks" || blockData.type == 123) ? document.getElementById("focus-btn").removeAttribute("disabled") : document.getElementById("focus-btn").setAttribute("disabled","");
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						editor.clearHistory();
					}
				});
				parent.querySelectorAll("*:not(.disabled) > bl .openbtn").forEach((elm)=>{
					elm.onclick = function(e){
						var parentBlock = e.target.parentNode.parentNode;
						var hasDomInside = Boolean(parentBlock.childElementCount>1/*&&parentBlock.querySelector("div.collapsible").innerHTML.match(/"/)*/);
						if (hasDomInside) {
							parentBlock.classList.toggle("collapsible-container");
							parentBlock.querySelectorAll("div.collapsible").remove();
						} else {
							//If there is no child container, refresh the block and load what's inside.
							activeEditBlock = parentBlock;
							editor.getDoc().setValue(activeEditBlock.getAttribute("data"));
							editsave(true);
						}
					}
				});
				var list = parent.querySelectorAll(".collapsible");
				list.forEach((l)=>{
					new Sortable(l, {
						group: l.parentNode.getAttribute("data-group"),
						ghostClass: 'invis',
						dragClass: 'dragged',
						fallbackTolerance: 5,
						forceFallback: true,
						delayOnTouchOnly: true,
						animation: 150,
						handle: '.handle',
						fallbackOnBody: true,
						swapThreshold: 0.65,
						multiDrag: true,
						selectedClass: 'selected',
						onEnd: function(e){
							updatescript(e.from), updatescript(e.to);
							//Update Object ID of rules
							if (JSON.parse(e.item.getAttribute("data")).objectID != undefined && JSON.parse(e.item.getAttribute("data")).abilityID != undefined) e.item.setAttribute("data",e.item.getAttribute("data").replace(/("objectID":")[A-Z0-9\-]*?"/i,"$1" + (JSON.parse(e.to.parentNode.getAttribute("data")).objectID||"") + "\"") );
						}
					});
				});
			}
			
			function replaceRender(data, tct, desc) {
				if (data == -1) {
					desc = "Entire Project";
					if (hsProject.scenes) {
						data = hsProject.scenes, tct = "scenes";
					} else {
						data = hsProject.objects||[], tct = "objects";
					}
				}
				document.getElementById("blocks-container-resizer").innerHTML = '<div class="drag-handle">Block Rendering: ' + desc + (desc!="Entire Project"&&tct?' <a title="See Entire Project" href="javascript:replaceRender(-1)">&ic; <i class="fa fa-list-alt"></i></a>':'')+'</div><div id="blocks-container" class="bl-container" style="padding: 36px 8px;" data-group="'+tct+'"></div><div class="resizer"></div>';
				//Data = Data Array, Top Container Type (e.g. Rules, Objects)
				data.forEach(function(item) {
					var blockElm = document.createElement("div");
					var blockInfo = jsonToHtml(item, undefined, (item.type==123||typeof item == "string"||item.xPosition!=null||(item.objects&&data.length>1)));
					blockElm.setAttribute("class", blockInfo.classList);
					blockElm.setAttribute("data", blockInfo.data);
					if (blockInfo.id) blockElm.setAttribute("data-id", blockInfo.id);
					blockElm.setAttribute("data-group", blockInfo.sortGroup);
					blockElm.innerHTML = blockInfo.innerHTML;
					document.getElementById("blocks-container").appendChild(blockElm);
				});
				
				x = new Sortable(document.getElementById("blocks-container"), {
					group: tct,
					ghostClass: 'invis', dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					onEnd: function(e){
						updatescript(e.from), updatescript(e.to);
					}
				});
				
				document.querySelector(".bl-container").setAttribute("data-group", tct);
				
				addBlockFunctions(document);
				updateDrawers();
			}
			setTimeout(function(){
				var url = new URL(location.href);
				if (localStorage.getItem("projectFromStorage") &&  url.searchParams.get("play") == "1") {
					var projectImport;
					if (!localStorage.getItem("projectFromStorage").match(/^\{/)) projectImport = JSON.parse(LZString.decompressFromUint8Array(new Uint8Array(localStorage.getItem("projectFromStorage").match(/[\w\d]{2}/g).repeatEach(val=>parseInt(val,16))))); /\}/
					hsProject = projectImport || JSON.parse(localStorage.getItem("projectFromStorage"));
					formatProject(hsProject);
					replaceRender(-1); //-1 means top (entire project)
				} else {
					req_id = (new URL(location.href)).searchParams.get("id") || localStorage.getItem("defaultProjUrl")?localStorage.getItem("defaultProjUrl"):(prompt("Project UUID","test")||"").replace(/.*\//,"");
					req_id = (new URL(location.href)).searchParams.get("id") || req_id;
					if (req_id) XHR.fetch("https://c.gethopscotch.com/api/v1/projects/"+req_id, function(r){
						try {
							hsProject = JSON.parse(r);
						} catch (E) {
							return alert("Invalid Response");
						}
						formatProject(hsProject);
						replaceRender(-1); //-1 means top (entire project)
					},true);
					else {
						replaceRender([],"","No project loaded");
					}
				}
			}, 400);
			
			var activeEditBlock;
			function editclose() {
				document.querySelector(".edit-box").style.display = "none";
				activeEditBlock = null;
			}
			function editsave(forceOpen) {
				forceOpen = forceOpen||false; // swap state?
				var savetext = editor.getValue()/*document.querySelector(".edit-box textarea").value*/||'{}';
				try {
					//Valid Block
					if (JSON.parse(savetext).type == 123) {
						var data = JSON.parse(savetext);
						//Create New Ability with name if it does not exist already
						var added = false, before = "";
						(hsProject.abilities||[]).forEach(a=>{if (a.abilityID == (data.controlScript||{}).abilityID) {
							added=true,before=a.name;
							a.name=data.description;
						}});
						if (!added) {
							newAbil = {name:data.description,createdAt:hsProject.abilities.repeatEach(a=>{return a.createdAt||0}).sort((a,b)=>b-a)[0]+12.345678||0,abilityID:(data.controlScript||{}).abilityID};
							if (newAbil) hsProject.abilities.push(newAbil);
							projectDict.abilities[(data.controlScript||{}).abilityID] = newAbil;
						} else {
							//Renamed Ability means project needs to refresh
							if (before != data.description) {
								var currentActive = activeEditBlock;
								//Update each visible ability block with that same control script ID
								document.querySelectorAll('.abl[data-group="blocks"][data-id="('+data.controlScript.abilityID+')"]').forEach(abl=>{
									activeEditBlock = abl;
									var blockData = JSON.parse(abl.getAttribute("data"));
									blockData.description = data.description;
									editor.getDoc().setValue(JSON.stringify(blockData));
									editsave();
								});
								activeEditBlock = currentActive;
							}
						}
						if (data.description != null) (projectDict.abilities[(data.controlScript||{}).abilityID]||{}).name = data.description;
					}
					var info = jsonToHtml(JSON.parse(savetext), undefined, !(forceOpen||activeEditBlock.classList.contains("collapsible-container")));
					//Open the block if forced to open or is already open
					activeEditBlock.innerHTML = info.innerHTML;
					activeEditBlock.setAttribute("class", info.classList);
					activeEditBlock.setAttribute("data", info.data);
					if (info.id) activeEditBlock.setAttribute("data-id", info.id);
					activeEditBlock.setAttribute("data-group", info.sortGroup);
					
					var activeParent = activeEditBlock.parentNode;
					if (!activeEditBlock.innerHTML) activeEditBlock.parentNode.removeChild(activeEditBlock);
					if (activeEditBlock.innerHTML && document.querySelector(".edit-box").style.display == "block") updatescript(activeEditBlock, true);
					updatescript(activeParent);
					document.querySelector(".edit-box").style.display = "none";
					addBlockFunctions(activeEditBlock);
					activeEditBlock = null;
				} catch (E) {
					console.error(E);
					//Valid JSON but invalid block, can indicate delete
					try {
						JSON.parse(savetext);
						document.querySelector(".edit-box").style.display = "none";
						activeEditBlock = null;
					} catch (E) {
						alert("Invalid JSON");
					}
				}
			}
			function editdelete() {
				editor.getDoc().setValue('{}');
				var parent = activeEditBlock.parentNode;
				if (activeEditBlock) editsave();
				//updatescript(parent);
			}
			function editfocus() {
				var blockData = JSON.parse(activeEditBlock.getAttribute("data"));
				document.getElementById("blocks-container-resizer").setAttribute("data", JSON.stringify(blockData));
				console.log("blocks", projectDict.objects[blockData.objectID||"idk"]);
				if (blockData.objects) replaceRender(blockData.objects, "objects", "Objects in \u201C" + blockData.name + "\u201D");
				else if (blockData.rules) replaceRender(blockData.rules, "rules", "Rules of \u201C" + blockData.name + "\u201D");
				else if (blockData.abilityID) replaceRender(Object.keys(projectDict.abilities[blockData.abilityID].blocks).repeatEach(b=>{return projectDict.abilities[blockData.abilityID].blocks[b]}), "blocks", "When \u201C" + (blockLabels[(blockData.parameters[0].datum||{}).type][1]||"").replace(/\u2063\s|\s\u2063/g,"") + "\u201D for \u201C" + (blockData.objectID?projectDict.objects[blockData.objectID||{}].name:JSON.parse(activeEditBlock.parentNode.parentNode.getAttribute("data")).name) + "\u201D");
				else if (blockData.controlScript) replaceRender(Object.keys(projectDict.abilities[blockData.controlScript.abilityID].blocks).repeatEach(b=>{return projectDict.abilities[blockData.controlScript.abilityID].blocks[b]}), "blocks", "Blocks in \u201C" + blockData.description + "\u201D");
				//console.log(activeEditBlock,jsonToHtml(blockData).focusType);
				document.getElementById("blocks-container").setAttribute("data", JSON.stringify(blockData));
				editclose();
			}
			function editcopy() {
				var newNode = document.createElement("div");
				activeEditBlock.parentNode.insertBefore(newNode, activeEditBlock);
				newNode.innerHTML = activeEditBlock.innerHTML;
				newNode.class = activeEditBlock.class;
				newNode.setAttribute("data", activeEditBlock.getAttribute("data"));
				console.log(newNode);
				newNode.setAttribute("data-id", activeEditBlock.getAttribute("data-id"));
				newNode.setAttribute("data-groupt", activeEditBlock.getAttribute("data-group"));
				editsave();
				
				activeEditBlock = newNode;
				editor.getDoc().setValue(activeEditBlock.getAttribute("data"));
				editsave();
			}
			document.body.onkeydown = function(e) {
				if (e.keyCode == 46 && !activeEditBlock) {
					document.getElementById("blocks-container").querySelectorAll(".selected").forEach(e=>{
						activeEditBlock = e;
						editdelete();
					});
				}
				if (!activeEditBlock) return;
				if (e.keyCode == 27) editclose();
				if ((e.ctrlKey||e.metaKey)&&e.keyCode == 13) editsave();
			}
			function writedata(type, web_id, newdata, isParent) {
				switch (type) {
					case "project":
						if (newdata[0].objects) {
							//Write to scenes (newer projects)
							hsProject.scenes = newdata.removeNull();
						} else {
							//Write to objects (older projects)
							hsProject.objects = newdata;
						}
						break;
					case "scene":
						projectDict.scenes[web_id] = newdata;
						var added = false;
						for (i = 0; i < (hsProject.scenes||[]).length; i++){
							if (hsProject.scenes[i].web_id == web_id) {
								added = true;
								hsProject.scenes[i] = newdata;
								hsProject.scenes[i].web_id = web_id;
							}
						}
						if (!added && !isParent && newdata) {
							newdata.web_id = web_id;
							hsProject.scenes.push(newdata);
						}
						break;
					case "object":
						projectDict.objects[web_id] = newdata;
						var added = false;
						for (i = 0; i < (hsProject.objects.removeNull()||[]).length; i++) {
							if (hsProject.objects[i].objectID == web_id) hsProject.objects[i] = newdata, added = true;
						};
						if (!added && !isParent && newdata) hsProject.objects.push(newdata);
						break;
					case "crule":
						projectDict.customRules[web_id] = newdata;
						var added = false;
						for (i = 0; i < (hsProject.customRules||[]).length; i++) {
							if (hsProject.customRules[i].id == web_id) hsProject.customRules[i] = newdata, added = true;
						};
						if (!added && !isParent && newdata) hsProject.customRules.push(newdata);
						break;
					case "rule":
						projectDict.rules[web_id] = newdata;
						var added = false;
						for (i = 0; i < (hsProject.rules||[]).length; i++) {
							if (hsProject.rules[i].id == web_id) hsProject.rules[i] = newdata, added = true;
						};
						if (!added && !isParent && newdata) hsProject.rules.push(newdata);
						break;
					case "ability": //Input the whole new ability
						newdata.name = (projectDict.abilities[web_id]||{}).name;
						projectDict.abilities[web_id] = projectDict.abilities[web_id]||{},
							projectDict.abilities[web_id].blocks = {},
							projectDict.abilities[web_id].name = newdata.name,
							projectDict.abilities[web_id].createdAt = newdata.createdAt,
							projectDict.abilities[web_id].abilityID = newdata.abilityID;
						for (i = 0; i < (newdata.blocks||[]).length; i++) {
							newblock = newdata.blocks[i];
							newblock.web_id = web_id + "_b" + i;
							projectDict.abilities[web_id].blocks[newblock.web_id] = newblock;
						}
						var added = false;
						for (i = 0; i < (hsProject.abilities||[]).length; i++) {
							if (hsProject.abilities[i].abilityID == web_id) {
								added = true;
								for (j = 0; j < (newdata.blocks||[]).length; j++) {
									newdata.blocks[j].web_id = web_id + "_b" + j;
								}
								hsProject.abilities[i] = newdata;
								hsProject.abilities[i].blocks = newdata.blocks;
							}
						};
						if (!added && newdata){//&& !isParent) {
							for (i = 0; i < (newdata.blocks||[]).length; i++) {
								newdata.blocks[i].web_id = web_id + "_b" + i;
							};
							hsProject.abilities.push(newdata);
							console.log("new ability", newdata)
						}
						break;
					//There is no need to update a block because it updates the ability regardless
				}
				var url = new URL(location.href);
				if (url.searchParams.get("play") == "1") {
					try {
						localStorage.setItem("projectFromStorage", JSON.stringify(unformatProject(hsProject)));
						console.log("%cProject Instance Saved","color:lime;font-weight:600;");
					} catch (e) {
						try {
							localStorage.setItem("projectStorageState","saving");
							saveCompressed();
						} catch (e) {
							if (!storageWarning) alert("Data cannot be written to this project")
							storageWarning = true;
						}
					}
				}
				updateDrawers();
			}
			function updateDrawers() {
				document.getElementById("abilities-drawer").innerHTML = '<div data="{&quot;block_class&quot;:&quot;control&quot;,&quot;description&quot;:&quot;&quot;,&quot;type&quot;:123,&quot;controlScript&quot;:{&quot;abilityID&quot;:&quot;&quot;}}" data-group="blocks"><bl class="abl"><b class="openbtn"></b><c>New Ability</c><b class="editbtn"></b><b class="handle"></b></bl></div>';
				document.getElementById("customRules-drawer").innerHTML = '<div data="{&quot;name&quot;:&quot;New Custom Rule&quot;,&quot;rules&quot;:[],&quot;id&quot;:&quot;&quot;}" data-group="rules"><bl class="crule"><b class="openbtn"></b><c>New Custom Rule</c><b class="editbtn"></b><b class="handle"></b></bl></div>';
				(hsProject.abilities||[]).forEach(ab=>{
					if (!ab.name) return;
					var abBlock = document.createElement("div");
					abBlock.setAttribute("data",JSON.stringify({"block_class":"control","description":ab.name,"type":123,"controlScript":{"abilityID":ab.abilityID}}));
					abBlock.setAttribute("data-group","blocks");
					abBlock.innerHTML = '<bl class="abl"><b class="openbtn"></b><c>'+ab.name+'</c><b class="editbtn"></b><b class="handle"></b></bl>';
					document.getElementById("abilities-drawer").appendChild(abBlock);
				});
				(hsProject.customRules||[]).forEach(cr=>{
					var crBlock = document.createElement("div");
					crBlock.setAttribute("data",JSON.stringify({"name":cr.name,"rules":cr.rules,"id":cr.id}));
					crBlock.setAttribute("data-group","rules");
					crBlock.innerHTML = '<bl class="crule"><b class="openbtn"></b><c>'+cr.name+'</c><b class="editbtn"></b><b class="handle"></b></bl>';
					document.getElementById("customRules-drawer").appendChild(crBlock);
				});
			}
			function saveCompressed() {
				//Calls the worker function
				var worker = new Worker(URL.createObjectURL(new Blob(["("+compress.toString()+")("+JSON.stringify(unformatProject(hsProject))+")"], {type: 'text/javascript'})));
				worker.onmessage = function(e) {
					localStorage.setItem("projectFromStorage", e.data.value.replace(/\s/g,""));
					console.log("%cProject Instance Saved","color:green;font-weight:600;");
					console.log(hsProject);
					localStorage.setItem("projectStorageState","saved");
				}
			}
			var storageWarning = false;
			function updatescript(container, isBlock) {
				isBlock = isBlock||false;
				var cp = (!isBlock) ? container.parentNode : container;
				var scData = JSON.parse(cp.getAttribute("data"));
				scType = !scData ? "project" : (scData.objects?"scene":(scData.xPosition!=undefined?"object":(scData.rules?"crule":(scData.abilityID?"rule":"ability"))));
				scId = (!scData ? "none" : scData.web_id||scData.id||scData.abilityID||scData.objectID||cp.getAttribute("data-id"));
				if (scData && (scData.controlScript || scData.controlFalseScript)) scId = (container.previousElementSibling && container.previousElementSibling.classList.contains("collapsible")) ? scData.controlFalseScript.abilityID : scData.controlScript.abilityID
				var newdata = {};
				//console.warn(newdata, isBlock, scType)
				if (isBlock && scType == "ability") return;
				switch (scType) {
					case "ability": //Change the parent ability
						newdata = {
							"abilityID": scId,
							"blocks": container.children.repeatEach(c=>{
								return JSON.parse(c.getAttribute("data"));
							}),
							"createdAt": (projectDict.abilities[scId]||{createdAt:newestCreateDate}).createdAt
						};
						if (scData.name) newdata.name = scData.name;
						break;
					case "rule":
						if (isBlock) {
							//Change the rule block itself
							newdata = scData;
							scId = scData.id;
						} else {
							//Change the ability within the rule
							newdata = {
								"abilityID": scData.abilityID,
								"blocks": container.children.repeatEach(c=>{
									return JSON.parse(c.getAttribute("data"));
								}),
								"createdAt": (projectDict.abilities[scData.abilityID]||{createdAt:newestCreateDate}).createdAt
							};
							if (scData.name) newdata.name = projectDict.abilities[scData.abilityID].name;
							scType = "ability";
							scId = scData.abilityID;
						}
						break;
					case "crule": //Change the rules within the custom rule
					case "object": //Change the rules within the object
						newdata = scData;
						if (!isBlock) newdata.rules = container.children.repeatEach(c=>{
							return JSON.parse(c.getAttribute("data")||'{}').id;
						});
						scId = scData.id||scData.objectID;
						break;
					case "scene": //Change the objects in the scene
						newdata = scData;
						if (!isBlock) newdata.objects = container.children.repeatEach(c=>{
							return JSON.parse(c.getAttribute("data")).objectID;
						});
						break;
					case "project":
						newdata = document.querySelectorAll(".bl-container > div").repeatEach(c=>{
							return JSON.parse(c.getAttribute("data"));
						});
						break;
				}
				if (scType == "crule" || scType == "object" || scType == "scene") cp.setAttribute("data", JSON.stringify(newdata));
				writedata(scType, scId, newdata, !isBlock);
			}
			/* CodeMirror */
			var editor = CodeMirror.fromTextArea(document.querySelector("textarea"), {
				matchBrackets: true,
				autoCloseBrackets: true,
				mode: "application/ld+json",
				foldGutter: true,
				lint: true,
				gutters: ["CodeMirror-lint-markers","CodeMirror-linenumbers", "CodeMirror-foldgutter"],
				lineWrapping: false,
				value: '{}',
				lineNumbers: true,
				indentWithTabs: true,
				tabSize: 2
			});
			editor.on("change",function(e){
				try {
					JSON.parse(editor.getValue());
					//console.log("Successful JSON Parse")
					document.querySelector(".edit-box .block-preview").innerHTML = jsonToHtml(JSON.parse(editor.getValue())).innerHTML.replace(/<b class="editbtn"><\/b>/g,"").replace(/ class="(handle|openbtn)/g,' style="cursor:unset;opacity:1;" class="'+"$1");
				} catch (E) {}
			});
			/* Interact JS */
			interact('.resize-drag').resizable({
				//Resize from all edges and corners
				edges: { 
					right: ".resizer",
					bottom: ".resizer"
				},
				listeners: {
					move (event) {
						var target = event.target;
						var x = (parseFloat(target.getAttribute('data-x')) || 0);
						var y = (parseFloat(target.getAttribute('data-y')) || 0);
						//Update the element's style
						target.style.width = event.rect.width + 'px';
						target.style.height = event.rect.height + 'px';
						//Translate when resizing from top or left edges
						x += event.deltaRect.left, y += event.deltaRect.top;
						target.style.webkitTransform = target.style.transform = 'translate(' + x + 'px,' + y + 'px)';
					}
				},
				modifiers: [
					//Keep the edges inside the parent
					interact.modifiers.restrictEdges({
						//outer: 'parent'
					}),
					//Minimum size
					interact.modifiers.restrictSize({
					min: { width: 200, height: 150 }
					})
				],
				inertia: true
			}).draggable({
				allowFrom: 'div.drag-handle',
				//Enable inertial throwing
				inertia: true,
				//Keep the element within the area of it's parent
				modifiers: [
					interact.modifiers.restrictRect({
					restriction: //'parent',
					{x: 0, y: 0, width: 10000, height: 4000},
					endOnly: true
					})
				],
				//Enable autoScroll
				autoScroll: true,

				listeners: {
					//Call this function on every dragmove event
					move (event) {
						var target = event.target;
						//Keep the dragged position in the data-x/data-y attributes
						var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
						var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
						
						//Translate the element
						target.style.webkitTransform = target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';// update the posiion attributes
						target.setAttribute('data-x', x); target.setAttribute('data-y', y);
					}
				}
			});
			//Z Index of draggable elements
			var draggables = document.querySelectorAll(".resize-drag");
			for (i = 0; i < draggables.length; i++) {
				draggables[i].style.zIndex = i;
				draggables[i].onmousedown = draggables[i].onclick =  draggables[i].ontouchstart = function(event) {
					var target = event.target;
					while (!target.classList.contains("resize-drag")) {
						if (target.parentNode) target = target.parentNode; else break;
					}
					//Set Z Index of the elements
					for (i = 0; i < draggables.length; i++) {
						if (Number(draggables[i].style.zIndex) > Number(target.style.zIndex)) draggables[i].style.zIndex = draggables[i].style.zIndex - 1;
					};
					target.style.zIndex = document.querySelectorAll(".resize-drag").length;
				}
			};
			/* Sortable JS */
				new Sortable(document.getElementById("blocks-drawer"), {
					group: { name: "blocks", pull: "clone", put: false },
					sort: false,
					//ghostClass: 'invis',
					dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					fallbackOnBody: true,
					onEnd: function(e){
						if (e.from == e.to) return;
						activeEditBlock = e.item;
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						editsave();
						updatescript(e.to);
					}
				});
				new Sortable(document.getElementById("abilities-drawer"), {
					group: { name: "blocks", pull: "clone", put: false },
					sort: false,
					//ghostClass: 'invis',
					dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					fallbackOnBody: true,
					onEnd: function(e){
						if (e.from == e.to) return;
						//Set the Ability ID
						e.item.setAttribute("data",e.item.getAttribute("data").replace(/("abilityID":")"/,"$1" + uuidv4().toUpperCase() + "\"") );
						activeEditBlock = e.item;
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						updatescript(e.item, true);
						updatescript(e.to);
					}
				});
				new Sortable(document.getElementById("rules-drawer"), {
					group: { name: "rules", pull: "clone", put: false },
					sort: false,
					//ghostClass: 'invis',
					dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					fallbackOnBody: true,
					onEnd: function(e){
						if (e.from == e.to) return;
						//Set the Ability ID and the ID. Also set the Object ID of a rule so that it works in an older editor version
						e.item.setAttribute("data",e.item.getAttribute("data").replace(/("abilityID":")"/,"$1" + uuidv4().toUpperCase() + "\"")
																			  .replace(/("id":")"/,"$1" + uuidv4().toUpperCase() + "\"")
																			  .replace(/("objectID":")"/,"$1" + (JSON.parse(e.to.parentNode.getAttribute("data")).objectID||"") + "\"") );
						activeEditBlock = e.item;
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						editsave();
						updatescript(e.item, true);
						updatescript(e.to);
					}
				});
				new Sortable(document.getElementById("customRules-drawer"), {
					group: { name: "rules", pull: "clone", put: false },
					sort: false,
					//ghostClass: 'invis',
					dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					fallbackOnBody: true,
					onEnd: function(e){
						if (e.from == e.to) return;
						e.item.setAttribute("data",e.item.getAttribute("data").replace(/("(id)":")"/g,"$1" + uuidv4().toUpperCase() + "\""));
						activeEditBlock = e.item;
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						editsave();
						updatescript(e.item, true);
						updatescript(e.to);
					}
				});
				new Sortable(document.getElementById("objects-drawer"), {
					group: { name: "objects", pull: "clone", put: false },
					sort: false,
					//ghostClass: 'invis',
					dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					fallbackOnBody: true,
					onEnd: function(e){
						if (e.from == e.to) return;
						e.item.setAttribute("data",e.item.getAttribute("data").replace(/("objectID":")"/g,"$1" + uuidv4().toUpperCase() + "\""));
						activeEditBlock = e.item;
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						editsave();
						updatescript(e.item, true);
						updatescript(e.to);
					}
				});
				new Sortable(document.getElementById("scenes-drawer"), {
					group: { name: "scenes", pull: "clone", put: false },
					sort: false,
					//ghostClass: 'invis',
					dragClass: 'dragged', fallbackTolerance: 5,
					forceFallback: true, delayOnTouchOnly: true, animation: 150,
					handle: '.handle', multiDrag: true, selectedClass: 'selected',
					fallbackOnBody: true,
					onEnd: function(e){
						if (e.from == e.to) return;
						e.item.setAttribute("data",e.item.getAttribute("data").replace(/\{/g,'{"web_id":"s' + (hsProject.scenes||[]).length + '",')); /\}/;
						activeEditBlock = e.item;
						editor.getDoc().setValue(JSON.stringify(JSON.parse(activeEditBlock.getAttribute("data")),null,"\t"));
						editsave();
						updatescript(e.item, true);
						updatescript(e.to);
					}
				});
			window.addEventListener("blur",function(){
				if ((document.activeElement.parentNode.parentNode.classList||document.body.classList).contains("resize-drag")) document.activeElement.parentNode.parentNode.click();
			});
		</script>
	</body>
</html>