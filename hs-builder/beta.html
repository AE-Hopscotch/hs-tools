<!DOCTYPE html>
<html>
	<head>
		<title>HS Builder Beta</title>
		<link href='https://fonts.googleapis.com/css?family=Dancing%20Script' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Francois%20One' rel='stylesheet'>
		<link href='https://fonts.googleapis.com/css?family=Lilita%20One' rel='stylesheet'>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="../style.css">
		<link rel="stylesheet" href="style.css">
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" href="https://aws1.discourse-cdn.com/gethopscotch/original/3X/3/8/3836ff26c18740a553e96462dc1ece3d8e7f4869.png">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		
		<link rel="apple-touch-icon" sizes="180x180" href="/hs-tools/icons/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/hs-tools/icons/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/hs-tools/icons/favicon-16x16.png">
		<link rel="manifest" href="/hs-tools/icons/site.webmanifest">
		<link rel="mask-icon" href="/hs-tools/icons/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/hs-tools/icons/favicon.ico">
		<meta name="apple-mobile-web-app-title" content="Hopscotch Tools">
		<meta name="application-name" content="Hopscotch Tools">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="msapplication-config" content="/hs-tools/icons/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
		
		<meta name="description" content="This is the ultimate online tool that can help you modify various traits of Hopscotch files!"/>
		<meta name="keywords" content="build, mod, text, project, hopscotch"/>
		<meta property="og:title" content="Hopscotch Project Builder Beta">
		<meta property="og:description" content="This is the ultimate online tool that can help you modify various traits of Hopscotch files!">
		<meta property="og:image" content="/hs-tools/images/hs-blueprint-file.png">
		
		<style>
		</style>
	</head>
	<body>
		<button onclick="theme()" id="themebtn"><i class="fa fa-fw fa-moon-o"> </i></button>
		<sq>
			<a href="javascript:home()" style="display:block;"><svg id="homeSvg" style="fill:#eee;" fixed version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 460.298 460.297" style="enable-background:new 0 0 460.298 460.297;" xml:space="preserve"><g><g><path d="M230.149,120.939L65.986,256.274c0,0.191-0.048,0.472-0.144,0.855c-0.094,0.38-0.144,0.656-0.144,0.852v137.041c0,4.948,1.809,9.236,5.426,12.847c3.616,3.613,7.898,5.431,12.847,5.431h109.63V303.664h73.097v109.64h109.629c4.948,0,9.236-1.814,12.847-5.435c3.617-3.607,5.432-7.898,5.432-12.847V257.981c0-0.76-0.104-1.334-0.288-1.707L230.149,120.939z"/><path d="M457.122,225.438L394.6,173.476V56.989c0-2.663-0.856-4.853-2.574-6.567c-1.704-1.712-3.894-2.568-6.563-2.568h-54.816c-2.666,0-4.855,0.856-6.57,2.568c-1.711,1.714-2.566,3.905-2.566,6.567v55.673l-69.662-58.245c-6.084-4.949-13.318-7.423-21.694-7.423c-8.375,0-15.608,2.474-21.698,7.423L3.172,225.438c-1.903,1.52-2.946,3.566-3.14,6.136c-0.193,2.568,0.472,4.811,1.997,6.713l17.701,21.128c1.525,1.712,3.521,2.759,5.996,3.142c2.285,0.192,4.57-0.476,6.855-1.998L230.149,95.817l197.57,164.741c1.526,1.328,3.521,1.991,5.996,1.991h0.858c2.471-0.376,4.463-1.43,5.996-3.138l17.703-21.125c1.522-1.906,2.189-4.145,1.991-6.716C460.068,229.007,459.021,226.961,457.122,225.438z"/></g></g></svg></a>
		</sq>
		<a id="invis-link" style="position:fixed;top:-64px;left:-64px;z-index:10;">Download</a>
		
		<div class="top-banner">
			<img src="../images/hs-blueprint-file.png" width="48"/>
			<h1>Hopscotch Project Builder</h1>
			<button id="upload-btn" onclick="popup.importProject()"><i class="fa fa-upload"></i> Open Project</button>
			<button id="download-btn" onclick="downloadProject()"><i class="fa fa-download"></i> Download</button>
		</div>
		<div hidden class="popup">
			<div hidden class="container" id="import">
				<i class="fa fa-close" onclick="popup.close()"></i>
				<span class="label">By URL</span>
				<input type="url" id="hs-project-link" placeholder="Project Link or UUID..." onkeydown="if(event.keyCode==13)importLink()"/>
				<br/><button onclick="importLink()">Go</button> <span id="link-ind" hidden>Uploading...</span>
				<br/><br/><span class="label">File Upload</span>
				<input hidden id="hs-project-file" type="file" accept=".hopscotch,.json,.txt" name="hs-project-file"/>
				<button id="hs-project-file-btn" style="margin-top:4px;"><i class="fa fa-upload"></i> Choose File</button>
				<span id="file-label">No file chosen</span>
			</div>
			<div hidden class="container" id="download">
				<i class="fa fa-close" onclick="popup.close()"></i>
				<span class="label" style="width:350px;text-align:center;margin:0 auto 8px;">Your download will begin shortly</span>
				<span style="display:block;margin:auto;text-align:center;">You will be redirected to the &ldquo;Import HS Project&rdquo; shortcut. In the case that you do not have the shortcut yet, download it <a href="https://www.icloud.com/shortcuts/96b5b223c62143568492ebb452f6beb9">here</a>.<br/><br/>
				<span>If you are saving a draft, choose &ldquo;This is my draft,&rdquo; and save it to the location below:</span>
				<img src="../images/save-location.jpg" width="250" style="border-radius:8px;display:block;margin:8px auto;">
				<span>If you are importing the project, choose &ldquo;I downloaded another project.&rdquo;</span>
				</span>
			</div>
		</div>
		<div style="position:relative; top:72px;">
			<table id="traits-table">
				<tr>
					<td>
						<h3>Stage Size</h3>
						<table style="--input-width:100px;"><tr>
							<td><span>Width:</span><td><input id="stageSize.width" type="number"/></td></tr><tr>
							<td><span>Height:</span><td><input id="stageSize.height" type="number"/></td>
						</tr></table>
					</td>
					<td>
						<h3>Editor Version</h3>
						<table style="--input-width:100px;"><tr>
							<td><input id="version" type="number"/></td>
						</tr></table>
					</td>
					<td>
						<h3>Player Version</h3>
						<table style="--input-width:100px;"><tr>
							<td><input id="playerVersion" type="string"/></td>
						</tr></table>
					</td>
				</tr>
				<tr>
					<td>
						<h3>Edited Date</h3>
						<table style="--input-width:200px;"><tr>
							<td><input id="edited_at" type="text"/></td>
						</tr></table>
					</td>
					<td>
						<h3>Base Object Scale</h3>
						<table style="--input-width:100px;"><tr>
							<td><input id="baseObjectScale" type="number"/></td>
						</tr></table>
					</td>
					<td>
						<h3>Font Size</h3>
						<table style="--input-width:100px;"><tr>
							<td><input id="fontSize" type="number"/></td>
						</tr></table>
					</td>
				</tr>
				<tr>
					<td>
						<h3>Requires Beta Editor</h3>
						<table style="--input-width:200px;"><tr>
							<td><select id="requires_beta_editor" value="false">
								<option>false</option><option>true</option>
							</select></td>
						</tr></table>
					</td>
					<td>
						<h3>Other</h3>
						<table><tr><td><span>Coming soon... this is only the beta release. There is still a lot to catch up on :)</span></td></tr></table>
					</td>
				</tr>
			</table>
		</div>
		<script src="../main.js"></script>
		<script src="../sidenav.min.js"></script>
		<script>
			//Read Link from Input
			function importLink() {
				var indicator = document.getElementById("link-ind");
				indicator.removeAttribute("hidden");
				var input = document.getElementById("hs-project-link").value;
				if (input == "") {
					indicator.innerHTML = "Please enter a link";
					return;
				} else if (input.match(/https?:\/\/.*/) && !input.match(/https?:\/\/c(ommunity)?.gethopscotch.com\/(p|projects|e)\//)) {
					indicator.innerHTML = "Please enter a Hopscotch link";
					return;
				}
				indicator.innerHTML = "Uploading..."
				input = input.split('/p/')[1] || input.split('/projects/')[1] || input.split('/e/')[1] || input;
				XHR.get("https://c.gethopscotch.com/api/v1/projects/" + input, function(r,s){
					if (s != 200) { //404 page
						indicator.innerHTML = (s == 500) ? "This project does not exist" : "Server Error";
					} else {
						hsProject = JSON.parse(r);
						indicator.setAttribute("hidden","");
						updateFields();
						popup.close();
					}
				}, true);
			}
			
			//Read User Input File
			document.getElementById('hs-project-file-btn').addEventListener('click', function(event){
				document.getElementById('hs-project-file').click();
				document.getElementById('hs-project-file').value = "";
				getFile(event);
			});
			document.getElementById('hs-project-file').addEventListener('change', getFile);
			function getFile(event) {
				const input = event.target;
				document.getElementById("file-label").innerHTML = (input.value||"").replace(/^.*\\/,"")||"No file chosen";
				try {
					var ext = input.files[0].name.split(".")[input.files[0].name.split(".").length-1];
				} catch (TypeError) {
					return;
				}
				var file = input.files[0];
				if ('files' in input && input.files.length > 0) {
					readFileContent(file).then(content => {
						try {
							hsProject = JSON.parse(content);
							hsProject.filename = input.value.replace(/^.*(\/|\\)/,"");
							updateFields(); popup.close();
							document.getElementById('hs-project-file').value = "";
						} catch (SyntaxError) { console.log('Invalid File'); document.getElementById("file-label").innerHTML = "Invalid File"; }
					}).catch(error => console.log(error))
				} else if ('files' in input && input.files.length > 0) console.log('Invalid File');
			}
			function readFileContent(file) {
				const reader = new FileReader()
				return new Promise((resolve, reject) => {
				reader.onload = event => resolve(event.target.result)
				reader.onerror = error => reject(error)
				reader.readAsText(file);
			  })
			}
			
			//Manage Popup
			var popup = {
				close: function() {
					document.querySelectorAll(".popup .container").forEach((e)=>e.setAttribute("hidden",""));
					document.querySelector(".popup").setAttribute("hidden","");
				},
				importProject: function() {
					document.querySelector("#import").removeAttribute("hidden","");
					document.querySelector(".popup").removeAttribute("hidden","");
				},
				download: function() {
					document.querySelector("#download").removeAttribute("hidden","");
					document.querySelector(".popup").removeAttribute("hidden","");
				}
			}
			document.body.onkeydown = function(e) {
				if (e.keyCode == 27) popup.close();
			}
			
			//
			var hsProject = {};
			
			function updateFields() {
				document.getElementById("stageSize.width").value = hsProject.stageSize.width;
				document.getElementById("stageSize.height").value = hsProject.stageSize.height;
				document.getElementById("version").value = hsProject.version;
				document.getElementById("playerVersion").value = hsProject.playerVersion||"1.0.0";
				document.getElementById("edited_at").value = hsProject.edited_at;
				document.getElementById("baseObjectScale").value = hsProject.baseObjectScale;
				document.getElementById("fontSize").value = hsProject.fontSize;
				document.getElementById("requires_beta_editor").value = hsProject.requires_beta_editor||false;
			}
			
			function updateProject(action) {
				switch (action) {
					case "stageSize.width":
						hsProject.stageSize.width = Number(document.getElementById("stageSize.width").value);
						break;
					case "stageSize.height":
						hsProject.stageSize.height = Number(document.getElementById("stageSize.height").value);
						break;
					case "version":
						hsProject.version = Number(document.getElementById("version").value);
						break;
					case "playerVersion":
						hsProject.playerVersion = document.getElementById("playerVersion").value;
						break;
					case "edited_at":
						hsProject.edited_at = document.getElementById("edited_at").value;
						break;
					case "baseObjectScale":
						hsProject.baseObjectScale = Number(document.getElementById("baseObjectScale").value);
						break;
					case "fontSize":
						hsProject.fontSize = Number(document.getElementById("fontSize").value);
						break;
					case "requires_beta_editor":
						hsProject.requires_beta_editor = Boolean(document.getElementById("requires_beta_editor").value);
						break;
				}
			}
			
			document.querySelectorAll("table table input, table table select").forEach((e)=>{
				e.onchange = function(){if (hsProject.uuid /*If project exists*/) updateProject(e.id)}; //Might change if exists later
			});
			
			//Reload Import
			var url = new URL(location.href);
			if (url.searchParams.get("reload") == "1") {
				hsProject = JSON.parse(localStorage.getItem("hsProject"));
				updateFields();
				localStorage.removeItem("hsProject");
				replaceLocation("");
				popup.download();
			}
			
			//Download Project
			function downloadProject() {
				if (!hsProject.uuid&&!hsProject.filename) return alert("There is no file to download");
				document.getElementById("download-btn").innerHTML = '<i class="fa fa-spinner fa-pulse"></i> Downloading...';
				if (/iPhone|iPad|iPod/.test(navigator.userAgent)) popup.download();
				var xhr = new XMLHttpRequest();
				var formData = new FormData();
				var jsonse = JSON.stringify(hsProject);
				var blob = new Blob([jsonse], {type: "application/json"});
				formData.append("file", blob, (hsProject.filename||hsProject.uuid+".hopscotch"));
				xhr.open("POST", "https://file.io/?expires=1d");
				xhr.onload = xhr.onerror = function(){
					if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
						location.href = 'workflow://run-workflow?name=Import%20HS%20Project&input={"name":"'+(hsProject.filename||hsProject.uuid+".hopscotch")+'","url":"' + (JSON.parse(xhr.responseText).link) + '"}';
						localStorage.setItem("hsProject",JSON.stringify(hsProject));
						setTimeout(function(){location.href = "?reload=1";},100);
					} else {
						location.href = JSON.parse(xhr.responseText).link;
					}
					document.getElementById("download-btn").innerHTML = '<i class="fa fa-download"></i> Download'
				}
				xhr.send(formData);
			}
		</script>
	</body>
</html>
